# תכנית מעבר מבלוקי זמינות 4 שעות ל-3 שעות

## סקירה כללית
המערכת הנוכחית עובדת עם בלוקי זמן של 4 שעות (0-4, 4-8, 8-12, 12-16, 16-20, 20-24).
המטרה: לעבור לבלוקי זמן של 3 שעות (0-3, 3-6, 6-9, 9-12, 12-15, 15-18, 18-21, 21-24) לגמישות רבה יותר.

## 📋 ממצאי החקירה

### קבצים מרכזיים שזוהו:

#### Frontend:
- `frontend/client/utils/availability.js` - **TIME_BLOCKS** (בלוקים של 4 שעות)
- `frontend/client/screens/OwnerAvailabilityScreen.js` - **TIME_SLOTS** (בלוקים של 4 שעות) 
- `frontend/client/components/AvailabilityEditor.js` - משתמש ב-**TIME_BLOCKS**

#### Backend:
- `backend/src/services/parkings.service.ts` - **isParkingAvailableByOwnerSettings()** (לוגיקה של בלוקים x4)
- `backend/src/services/bookings.service.ts` - **calculateAvailabilityFromSchedule()** (לוגיקה של בלוקים x4)
- `backend/src/services/extensions.service.ts` - **checkOwnerAvailability()** (לוגיקה של בלוקים x4)

### מבנה נתונים:
- **בסיס נתונים:** `parking.availability` (JSON string)
- **פורמט נוכחי:** `{ "sunday": [0,4,8,12,16,20], "monday": [...], ... }`
- **פורמט חדש (צפוי):** `{ "sunday": [0,3,6,9,12,15,18,21], "monday": [...], ... }`

---

## 🎯 תכנית העבודה - 6 שלבים

### **שלב 1: הכנה וקבועים חדשים** 📝
**משך צפוי:** 30 דקות

#### 1.1 עדכון קבועי הזמן - Frontend
- [ ] **קובץ:** `frontend/client/utils/availability.js`
  - [ ] עדכון **TIME_BLOCKS** מ-6 בלוקים (4 שעות) ל-8 בלוקים (3 שעות)
  - [ ] שינוי: `00:00-04:00` → `00:00-03:00, 03:00-06:00`
  - [ ] שינוי: `04:00-08:00` → `06:00-09:00, 09:00-12:00` וכו'

#### 1.2 עדכון קבועי הזמן - OwnerAvailabilityScreen
- [ ] **קובץ:** `frontend/client/screens/OwnerAvailabilityScreen.js`
  - [ ] עדכון **TIME_SLOTS** מ-6 בלוקים ל-8 בלוקים (3 שעות)

---

### **שלב 2: עדכון לוגיקת Backend** ⚙️
**משך צפוי:** 45 דקות

#### 2.1 עדכון פונקציית בדיקת זמינות בעלים
- [ ] **קובץ:** `backend/src/services/parkings.service.ts`
  - [ ] פונקציה: **isParkingAvailableByOwnerSettings()**
  - [ ] שינוי לוגיקה: `hour += 4` → `hour += 3`
  - [ ] שינוי חישוב: `Math.floor(hour / 4) * 4` → `Math.floor(hour / 3) * 3`
  - [ ] עדכון טווחים: `0, 4, 8, 12, 16, 20` → `0, 3, 6, 9, 12, 15, 18, 21`

#### 2.2 עדכון פונקציית חישוב זמינות
- [ ] **קובץ:** `backend/src/services/bookings.service.ts`
  - [ ] פונקציה: **calculateAvailabilityFromSchedule()**
  - [ ] שינוי לוגיקה: `Math.floor(hour / 4) * 4` → `Math.floor(hour / 3) * 3`
  - [ ] עדכון הערות ודוגמאות בקוד

#### 2.3 עדכון פונקציית בדיקת זמינות להארכות
- [ ] **קובץ:** `backend/src/services/extensions.service.ts`
  - [ ] פונקציה: **checkOwnerAvailability()**
  - [ ] שינוי: `Math.max(...daySettings) + 4` → `Math.max(...daySettings) + 3`

---

### **שלב 3: יצירת פונקציית מיגרציה** 🔄
**משך צפוי:** 60 דקות

#### 3.1 יצירת פונקציית המרה
- [ ] **קובץ חדש:** `backend/src/services/availability-migration.service.ts`
  - [ ] פונקציה: **migrate4HourBlocksTo3Hour()**
  - [ ] לוגיקת המרה:
    ```
    4-hour blocks → 3-hour blocks
    [0] (00:00-04:00) → [0, 3] (00:00-03:00, 03:00-06:00)
    [4] (04:00-08:00) → [3, 6] (03:00-06:00, 06:00-09:00)
    [8] (08:00-12:00) → [6, 9] (06:00-09:00, 09:00-12:00)
    [12] (12:00-16:00) → [12, 15] (12:00-15:00, 15:00-18:00)
    [16] (16:00-20:00) → [15, 18] (15:00-18:00, 18:00-21:00)
    [20] (20:00-24:00) → [18, 21] (18:00-21:00, 21:00-24:00)
    ```

#### 3.2 יצירת API endpoint למיגרציה
- [ ] **קובץ:** `backend/src/routes/admin.routes.ts`
  - [ ] POST `/api/admin/migrate-availability-blocks`
  - [ ] הגנה: admin בלבד
  - [ ] לוגים מפורטים לכל פעולה

#### 3.3 עדכון המיגרציה הקיימת בפרונטנד
- [ ] **קובץ:** `frontend/client/screens/OwnerAvailabilityScreen.js`
  - [ ] עדכון **migrateOldAvailability()** לתמיכה בשני סוגי מיגרציה
  - [ ] הוספת זיהוי פורמט (4 שעות vs 3 שעות)

---

### **שלב 4: בדיקות ותיקוף** 🧪
**משך צפוי:** 30 דקות

#### 4.1 יצירת בדיקות יחידה
- [ ] **קובץ חדש:** `backend/src/services/__tests__/availability-migration.service.test.ts`
  - [ ] בדיקת המרה נכונה לכל בלוק
  - [ ] בדיקת edge cases (בלוקים חסרים, ריקים)
  - [ ] בדיקת שמירה על תקינות הנתונים

#### 4.2 בדיקות integration
- [ ] בדיקת פונקציות Backend עם הנתונים החדשים
- [ ] בדיקת תצוגה Frontend עם 8 בלוקים
- [ ] בדיקת תאימות הזמנות קיימות

---

### **שלב 5: Deploy ומיגרציה בסביבת ייצור** 🚀
**משך צפוי:** 45 דקות

#### 5.1 הכנת סקריפט מיגרציה
- [ ] **קובץ חדש:** `backend/scripts/migrate-availability-4h-to-3h.js`
  - [ ] קריאה לכל החניות עם availability
  - [ ] המרה אוטומטית של הפורמט
  - [ ] גיבוי הנתונים הישנים
  - [ ] רישום סטטיסטיקות (כמה חניות הומרו)

#### 5.2 תהליך Deploy בטוח
- [ ] **שלב 1:** Deploy הקוד החדש (תואם לאחור)
- [ ] **שלב 2:** הרצת סקריפט המיגרציה
- [ ] **שלב 3:** בדיקת תקינות הנתונים
- [ ] **שלב 4:** מעקב אחר לוגי שגיאות

---

### **שלב 6: בדיקה ואופטימיזציה** ✅
**משך צפוי:** 30 דקות

#### 6.1 בדיקות פונקציונליות
- [ ] בדיקת יצירת זמינות חדשה (8 בלוקים)
- [ ] בדיקת עריכת זמינות קיימת (ממוגרת)
- [ ] בדיקת הזמנות חדשות עם הלוגיקה החדשה
- [ ] בדיקת הארכות עם הלוגיקה החדשה

#### 6.2 אופטימיזציות וחיפוש באגים
- [ ] מעקב אחר ביצועים (8 בלוקים במקום 6)
- [ ] בדיקת תצוגה במכשירים שונים
- [ ] תיקון בעיות UX/UI אם נדרש

---

## 🎨 שינויים ויזואליים צפויים

### לפני (6 בלוקים):
```
[00:00-04:00] [04:00-08:00] [08:00-12:00]
[12:00-16:00] [16:00-20:00] [20:00-24:00]
```

### אחרי (8 בלוקים):
```
[00:00-03:00] [03:00-06:00] [06:00-09:00] [09:00-12:00]
[12:00-15:00] [15:00-18:00] [18:00-21:00] [21:00-24:00]
```

---

## ⚠️ סיכונים ואמצעי ביטוח

### סיכונים מזוהים:
1. **אובדן נתונים** - פתרון: גיבוי מלא לפני מיגרציה
2. **תאימות לאחור** - פתרון: שמירה על זיהוי שני הפורמטים
3. **הזמנות קיימות** - פתרון: בדיקת impact לפני שינוי
4. **ביצועים** - פתרון: מעקב אחר זמני תגובה

### אמצעי ביטוח:
- [ ] גיבוי מלא של בסיס הנתונים לפני התחלה
- [ ] יכולת rollback מלא במקרה הצורך
- [ ] בדיקות בסביבת staging לפני ייצור
- [ ] מעקב לוגים מפורט לכל השלבים

---

## 📊 מדדי הצלחה

### KPIs למעקב:
- [ ] **100%** חניות הומרו בהצלחה
- [ ] **0** אובדן נתונים
- [ ] **< 2 שניות** זמן תגובה ממוצע
- [ ] **0** הזמנות שבורות
- [ ] **100%** תאימות Frontend/Backend

---

## 🔧 הערות טכניות

### תלויות:
- כרגע אין תלות חיצונית מיוחדת
- השינוי הוא פנימי במערכת בלבד

### חשיבות לוגים:
- כל שלב ירשום לוגים מפורטים
- במיוחד חשוב לתהליך המיגרציה
- לוגי שגיאות מפורטים לdebug מהיר

---

## ✅ Checklist סיכום

- [ ] כל הקבצים זוהו ונבדקו
- [ ] לוגיקת המיגרציה הוגדרה
- [ ] בדיקות יחידה נכתבו
- [ ] תהליך deploy מתוכנן
- [ ] אמצעי ביטוח במקום
- [ ] מדדי הצלחה מוגדרים

**סה"כ זמן צפוי: 3-4 שעות**
