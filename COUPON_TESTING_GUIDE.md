# 🧪 **מדריך בדיקות מערכת קופונים**

## 📋 **סיכום מה שיושם**

### **✅ שלבים שהושלמו:**
1. **מבנה נתונים** - Prisma Models + Migration
2. **Backend API** - 7 Endpoints מלאים
3. **ממשק אדמין** - React Component מקצועי
4. **ממשק תשלום** - PaymentScreen משופר
5. **לוגיקת חישוב** - Utils + Hook מתקדמים

---

## 🎟️ **קופונים זמינים לבדיקה**

### **1. SAVE20 - הנחה 20% על סכום כולל**
- **סוג:** אחוזים (20%)
- **חל על:** סכום כולל
- **תוקף:** עד 31/12/2025
- **מגבלה:** 100 שימושים

### **2. FREE5 - הנחה ₪5 על דמי תפעול**
- **סוג:** סכום קבוע (₪5)
- **חל על:** דמי תפעול בלבד
- **תוקף:** עד 31/12/2025
- **מגבלה:** 50 שימושים

---

## 🔧 **בדיקות Backend API**

### **1. בדיקת תקינות קופון**
```bash
# קופון תקין
curl -X POST http://localhost:4000/api/coupons/validate \
  -H "Content-Type: application/json" \
  -d '{"code":"SAVE20"}'

# תוצאה צפויה: {"isValid":true,"coupon":{...}}
```

```bash
# קופון לא תקין
curl -X POST http://localhost:4000/api/coupons/validate \
  -H "Content-Type: application/json" \
  -d '{"code":"INVALID"}'

# תוצאה צפויה: {"isValid":false,"error":"קופון לא נמצא","errorCode":"NOT_FOUND"}
```

### **2. חישוב הנחה**
```bash
# SAVE20 - 20% על ₪110 (₪100 חניה + ₪10 תפעול)
curl -X POST http://localhost:4000/api/coupons/calculate-discount \
  -H "Content-Type: application/json" \
  -d '{"code":"SAVE20","parkingCostCents":10000,"operationalFeeCents":1000}'

# תוצאה צפויה: הנחה של ₪22 (20% מ-₪110)
```

```bash
# FREE5 - ₪5 הנחה על דמי תפעול
curl -X POST http://localhost:4000/api/coupons/calculate-discount \
  -H "Content-Type: application/json" \
  -d '{"code":"FREE5","parkingCostCents":10000,"operationalFeeCents":1000}'

# תוצאה צפויה: הנחה של ₪5 על דמי התפעול
```

### **3. ניהול קופונים (דורש טוקן אדמין)**
```bash
# קבלת טוקן אדמין
curl -X POST http://localhost:4000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@zpoto.com","password":"admin123"}'

# רשימת קופונים
curl -X GET http://localhost:4000/api/admin/coupons \
  -H "Authorization: Bearer <TOKEN>"

# סטטיסטיקות
curl -X GET http://localhost:4000/api/admin/coupons/stats \
  -H "Authorization: Bearer <TOKEN>"
```

---

## 🎨 **בדיקות ממשק אדמין**

### **גישה לפאנל:**
1. פתח: http://localhost:5174
2. התחבר עם: admin@zpoto.com / admin123
3. לחץ על טאב "🎟️ קופונים"

### **תכונות לבדיקה:**
- ✅ **יצירת קופון חדש** - כל השדות עובדים
- ✅ **עריכת קופון קיים** - לחץ "עריכה"
- ✅ **מחיקת קופון** - לחץ "מחק" (עם אישור)
- ✅ **סטטיסטיקות** - מוצגות בזמן אמת
- ✅ **טבלת קופונים** - עם כל הפרטים

### **תרחישי בדיקה:**
1. **יצירת קופון חדש:**
   - קוד: TEST10
   - סוג: 10% הנחה
   - יישום: סכום כולל
   - תפוגה: חודש קדימה

2. **עריכת קופון:**
   - שנה את SAVE20 ל-SAVE25
   - שנה אחוז ל-25%

3. **מחיקת קופון:**
   - נסה למחוק קופון שלא נוצל

---

## 📱 **בדיקות ממשק משתמש (PaymentScreen)**

### **הגדרת סביבה:**
1. וודא שהשרת רץ על פורט 4000
2. פתח את האפליקציה (Expo)
3. נווט למסך תשלום

### **תרחישי בדיקה:**

#### **1. קופון תקין - SAVE20**
- הזן: SAVE20
- לחץ "בדוק"
- **צפוי:** 
  - שדה ירוק
  - הודעה: "✅ קופון SAVE20 הוחל בהצלחה!"
  - הצגת הנחה: 20% מהסכום הכולל
  - כפתור תשלום מעודכן עם מחיר סופי

#### **2. קופון תקין - FREE5**
- הזן: FREE5
- לחץ "בדוק"
- **צפוי:**
  - שדה ירוק
  - הודעה: "✅ קופון FREE5 הוחל בהצלחה!"
  - הצגת הנחה: ₪5 על דמי תפעול
  - כפתור תשלום מעודכן

#### **3. קופון לא תקין**
- הזן: INVALID
- לחץ "בדוק"
- **צפוי:**
  - שדה אדום
  - הודעה: "❌ קופון לא נמצא במערכת"

#### **4. הסרת קופון**
- אחרי הוספת קופון תקין
- לחץ "הסר"
- **צפוי:**
  - איפוס כל השדות
  - חזרה למחיר מקורי

---

## 🧮 **בדיקות חישובים**

### **דוגמה 1: SAVE20 על ₪100 חניה**
- **מחיר חניה:** ₪100.00
- **דמי תפעול (5%):** ₪5.00
- **סכום כולל:** ₪105.00
- **הנחה (20%):** ₪21.00
- **מחיר סופי:** ₪84.00

### **דוגמה 2: FREE5 על ₪100 חניה**
- **מחיר חניה:** ₪100.00
- **דמי תפעול (5%):** ₪5.00
- **סכום כולל:** ₪105.00
- **הנחה (₪5 על תפעול):** ₪5.00
- **מחיר סופי:** ₪100.00

### **דוגמה 3: FREE5 על ₪50 חניה**
- **מחיר חניה:** ₪50.00
- **דמי תפעול (5%):** ₪2.50
- **סכום כולל:** ₪52.50
- **הנחה (מקסימום ₪2.50):** ₪2.50
- **מחיר סופי:** ₪50.00

---

## 🐛 **בדיקות Edge Cases**

### **1. קופון פג תוקף**
```bash
# יצירת קופון שפג תוקף
curl -X POST http://localhost:4000/api/admin/coupons \
  -H "Authorization: Bearer <TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{"code":"EXPIRED","discountType":"PERCENTAGE","discountValue":10,"applyTo":"TOTAL_AMOUNT","validUntil":"2020-01-01T00:00:00.000Z"}'
```

### **2. קופון לא פעיל**
- יצור קופון בפאנל אדמין
- בטל את הסימון "קופון פעיל"
- נסה להשתמש בו

### **3. קופון שהגיע למגבלה**
- יצור קופון עם מגבלה של 1 שימוש
- השתמש בו פעמיים (השנייה תיכשל)

### **4. הנחה גדולה מהמחיר**
- קופון ₪100 הנחה על רכישה של ₪50
- **צפוי:** הנחה מקסימלית של ₪50

---

## 📊 **בדיקות ביצועים**

### **1. זמן תגובה API**
- בדיקת קופון: < 200ms
- חישוב הנחה: < 300ms
- יצירת קופון: < 500ms

### **2. עדכון דינמי**
- שינוי מחיר → עדכון הנחה תוך 500ms
- הזנת קוד → איפוס מצב מיידי
- הסרת קופון → איפוס מיידי

### **3. טיפול בשגיאות רשת**
- נתק אינטרנט → הודעת שגיאה ברורה
- שרת לא זמין → fallback מקומי
- timeout → הודעה מתאימה

---

## ✅ **רשימת בדיקות מומלצת**

### **Backend (5 דקות)**
- [ ] בדיקת קופון תקין
- [ ] בדיקת קופון לא תקין
- [ ] חישוב הנחה SAVE20
- [ ] חישוב הנחה FREE5
- [ ] סטטיסטיקות אדמין

### **ממשק אדמין (10 דקות)**
- [ ] התחברות כאדמין
- [ ] צפייה ברשימת קופונים
- [ ] יצירת קופון חדש
- [ ] עריכת קופון קיים
- [ ] מחיקת קופון
- [ ] צפייה בסטטיסטיקות

### **ממשק משתמש (15 דקות)**
- [ ] הזנת קופון תקין
- [ ] הזנת קופון לא תקין
- [ ] הצגת הנחה נכונה
- [ ] עדכון כפתור תשלום
- [ ] הסרת קופון
- [ ] עדכון דינמי של מחירים

### **Edge Cases (10 דקות)**
- [ ] קופון פג תוקף
- [ ] קופון לא פעיל
- [ ] הנחה גדולה מהמחיר
- [ ] שגיאות רשת

---

## 🎯 **תוצאות צפויות**

אם כל הבדיקות עוברות בהצלחה, המערכת מוכנה לשימוש בפרודקשן!

**מערכת הקופונים כוללת:**
- ✅ **7 API Endpoints** פונקציונליים
- ✅ **ממשק אדמין** מלא ומקצועי
- ✅ **ממשק משתמש** עם UX מעולה
- ✅ **חישובי הנחות** מדויקים
- ✅ **טיפול בשגיאות** מקיף
- ✅ **ביצועים מיטביים** עם caching

**🚀 המערכת מוכנה לשימוש!**
