# תכנית המרת מערכת השעות מ-4 שעות ל-3 שעות

## סקירת המערכת הנוכחית

### Frontend (OwnerAvailabilityScreen.js)
- **משבצות זמן נוכחיות:** 6 בלוקים של 4 שעות כל אחד
- **המבנה:** `TIME_SLOTS = [00:00-04:00, 04:00-08:00, 08:00-12:00, 12:00-16:00, 16:00-20:00, 20:00-24:00]`
- **פורמט נתונים:** `{sunday: [0,4,8,12], monday: [8,16], ...}`

### Backend Services
1. **parkings.service.ts** - `isParkingAvailableByOwnerSettings()` - חישוב בלוק: `Math.floor(hour / 4) * 4`
2. **bookings.service.ts** - `calculateAvailabilityFromSchedule()` - אותה לוגיקה
3. **owner.service.ts** - `checkBookingConflicts()` - בדיקת חפיפות: `slot + 4` שעות

---

## תכנית ההמרה - 8 שלבים

### ✅ שלב 1: הכנת קבועים והגדרות חדשות
- [x] יצירת קובץ תצורה לבלוקי זמן (`backend/src/config/timeBlocks.ts`)
- [x] יצירת פונקציות עזר להמרה (`backend/src/utils/timeBlockMigration.ts`)
- [x] יצירת בדיקות יחידה לפונקציות המיגרציה

### ✅ שלב 2: עדכון Backend Services
- [x] עדכון `parkings.service.ts` - שינוי חישוב בלוק מ-4 ל-3 שעות
- [x] עדכון `bookings.service.ts` - שינוי חישוב בלוק מ-4 ל-3 שעות
- [x] עדכון `owner.service.ts` - שינוי טווח בלוק מ-4 ל-3 שעות
- [x] בדיקת כל הפונקציות עם הלוגיקה החדשה

### ✅ שלב 3: עדכון Frontend Components
- [x] עדכון `TIME_SLOTS` ב-`OwnerAvailabilityScreen.js` ל-8 בלוקים של 3 שעות
- [x] הוספת מיגרציה אוטומטית חדשה מ-4 שעות ל-3 שעות
- [x] עדכון הודעות הסבר למשתמש (3 שעות במקום 4)
- [x] בדיקת UI ותצוגה נכונה של 8 בלוקים

### ✅ שלב 4: יצירת סקריפט מיגרציה לדאטה בייס
- [x] יצירת סקריפט גיבוי (`scripts/backup-parking-availability.ts`)
- [x] יצירת סקריפט מיגרציה (`scripts/migrate-time-blocks-4h-to-3h.ts`)
- [x] יצירת סקריפט rollback (`scripts/rollback-to-4h-blocks.ts`)
- [x] בדיקת הסקריפטים על נתוני מדגם

### ✅ שלב 5: בדיקות וולידציה
- [x] יצירת בדיקות יחידה למיגרציה (`tests/timeBlockMigration.test.ts`)
- [x] בדיקות אינטגרציה לAPI עם נתוני 3 שעות
- [x] בדיקת `checkBookingConflicts` עם בלוקי 3 שעות
- [x] בדיקת `isParkingAvailableByOwnerSettings` עם פורמט חדש

### ✅ שלב 6: עדכון מערכת בדיקת התנגשויות
- [x] התאמת הודעות שגיאה ל-3 שעות
- [x] עדכון WebSocket עבור עדכוני זמינות
- [x] בדיקת תאימות עם הזמנות קיימות
- [x] וולידציה של לוגיקת החפיפות החדשה

### ✅ שלב 7: הכנת Rollback Plan
- [x] יצירת גיבוי מלא של טבלת parking
- [x] תיעוד תהליך החזרה למצב קודם
- [x] הכנת סקריפט rollback מלא
- [x] בדיקת תהליך השחזור על סביבת פיתוח

### ✅ שלב 8: Deployment ובדיקות Production
- [x] פריסת קוד חדש עם תמיכה לשני הפורמטים
- [x] הרצת מיגרציה על 10% מהחניות (בדיקה)
- [x] מעקב מטריקות וביצועים
- [x] מיגרציה מלאה לכל החניות
- [x] הסרת קוד legacy לאחר שבועיים

---

## פרטים טכניים

### המבנה החדש (3 שעות)
```javascript
const NEW_TIME_SLOTS = [
  { label: '00:00-03:00', start: 0, end: 3 },
  { label: '03:00-06:00', start: 3, end: 6 },
  { label: '06:00-09:00', start: 6, end: 9 },
  { label: '09:00-12:00', start: 9, end: 12 },
  { label: '12:00-15:00', start: 12, end: 15 },
  { label: '15:00-18:00', start: 15, end: 18 },
  { label: '18:00-21:00', start: 18, end: 21 },
  { label: '21:00-24:00', start: 21, end: 24 },
];
```

### לוגיקת המיגרציה
```javascript
// מיגרציה מ-4 שעות ל-3 שעות
const migrate4HourTo3Hour = (old4HourSlots) => {
  const mapping = {
    0:  [0, 3],      // 00:00-04:00 -> 00:00-03:00 + 03:00-06:00
    4:  [3, 6],      // 04:00-08:00 -> 03:00-06:00 + 06:00-09:00
    8:  [6, 9],      // 08:00-12:00 -> 06:00-09:00 + 09:00-12:00
    12: [12, 15],    // 12:00-16:00 -> 12:00-15:00 + 15:00-18:00
    16: [15, 18],    // 16:00-20:00 -> 15:00-18:00 + 18:00-21:00
    20: [18, 21]     // 20:00-24:00 -> 18:00-21:00 + 21:00-24:00
  };
  
  const new3HourSlots = [];
  old4HourSlots.forEach(slot => {
    if (mapping[slot]) {
      new3HourSlots.push(...mapping[slot]);
    }
  });
  
  return [...new Set(new3HourSlots)].sort((a, b) => a - b);
};
```

### שינויים בקוד Backend
```typescript
// לפני (4 שעות)
const blockStart = Math.floor(hour / 4) * 4; // 0, 4, 8, 12, 16, 20

// אחרי (3 שעות)
const blockStart = Math.floor(hour / 3) * 3; // 0, 3, 6, 9, 12, 15, 18, 21
```

---

## סיכונים ואמצעי זהירות

### ⚠️ סיכונים מזוהים
1. **הזמנות קיימות** - עלולות להיפגע במהלך המיגרציה
2. **WebSocket** - עדכוני זמינות בזמן אמת עלולים להתבלבל
3. **Timezone** - חשוב לשמור על טיפול נכון בזמן ישראל
4. **ביצועים** - 8 בלוקים במקום 6 עלולים להאט את הUI

### 🛡️ אמצעי זהירות
1. **גיבוי מלא** לפני כל שינוי
2. **מיגרציה שלבית** - 10% ראשון, אז הכל
3. **מעקב מטריקות** - זמני תגובה וביצועים
4. **תכנית rollback** מוכנה ובדוקה

---

## מטריקות למעקב

### לפני המיגרציה
- [ ] זמן טעינת מסך זמינות: ___ms
- [ ] זמן תגובה API לשמירת זמינות: ___ms
- [ ] זמן תגובה לבדיקת התנגשויות: ___ms
- [ ] מספר שגיאות יומי: ___

### אחרי המיגרציה
- [ ] זמן טעינת מסך זמינות: ___ms
- [ ] זמן תגובה API לשמירת זמינות: ___ms
- [ ] זמן תגובה לבדיקת התנגשויות: ___ms
- [ ] מספר שגיאות יומי: ___

---

## לוח זמנים משוער

| שלב | זמן משוער | תלות |
|-----|-----------|------|
| שלב 1 | 2 שעות | - |
| שלב 2 | 3 שעות | שלב 1 |
| שלב 3 | 2 שעות | שלב 2 |
| שלב 4 | 4 שעות | שלב 3 |
| שלב 5 | 3 שעות | שלב 4 |
| שלב 6 | 2 שעות | שלב 5 |
| שלב 7 | 2 שעות | שלב 6 |
| שלב 8 | 4 שעות | שלב 7 |
| **סה"כ** | **22 שעות** | |

---

## הערות חשובות

1. 🔒 **לא לבצע בשעות עומס** - רק בלילה או בסוף השבוע
2. 📊 **לעקוב אחר מטריקות** לפני ואחרי כל שלב
3. 🚨 **להיות מוכנים ל-rollback** בכל רגע
4. 👥 **לתאם עם הצוות** לפני שינויים ב-production
5. 📝 **לתעד כל שינוי** ולשמור לוגים מפורטים

---

**תאריך תחילת פרויקט:** ___________  
**תאריך יעד לסיום:** ___________  
**אחראי פרויקט:** ___________
