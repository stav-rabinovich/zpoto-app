# 📊 תכנית מערכת עמלות זפוטו
## Commission System Implementation Plan

---

## 🎯 **מטרות המערכת**

### מודל העמלות:
- **15%** מסך ההכנסה של כל שעת חניה בתשלום
- **0%** עמלה על שעות חניה חינם
- **גבול תחתון**: 1 ש״ח עמלה מינימום לשעה בתשלום
- **מועד תשלום**: כל 1 לחודש

### דוגמה לחישוב עמלה:
```
שעה 1: 10 ש״ח → עמלה 1.5 ש״ח (15%)
שעה 2: 7 ש״ח → עמלה 1.05 ש״ח (15%)
שעה 3: 4 ש״ח → עמלה 0.6 ש״ח → מינימום 1 ש״ח
שעה 4: חינם → עמלה 0 ש״ח
סה״כ הכנסה: 21 ש״ח | סה״כ עמלה: 3.55 ש״ח | נטו לבעל: 17.45 ש״ח
```

---

## 📋 **שלבי הביצוע**

### **PHASE 1: Database & Backend Setup**

#### **Step 1.1: Database Schema** ✅
- [x] יצירת טבלת `Commission` לעמלות
- [x] יצירת טבלת `OwnerPayout` לתשלומים חודשיים
- [x] עדכון טבלת `Booking` להוספת שדות עמלה
- [x] יצירת אינדקסים לביצועים
- [x] הגדרת קשרים בין טבלאות

#### **Step 1.2: Commission Calculation Engine** ✅
- [x] פונקציית חישוב עמלה לפי שעות ומחירים
- [x] יישום חוק הגבול התחתון (1 ש״ח מינימום)
- [x] פונקציות לחישוב הכנסה נטו
- [x] פונקציות לקיבוץ עמלות לפי חודשים
- [x] בדיקות יחידה (Unit Tests)

#### **Step 1.3: API Endpoints** ✅
- [x] `POST /api/commissions/calculate` - חישוב עמלה להזמנה
- [x] `GET /api/commissions/owner/:ownerId/commissions` - עמלות של בעל חניה
- [x] `GET /api/commissions/owner/:ownerId/payouts` - היסטוריית תשלומים
- [x] `GET /api/commissions/admin/commissions` - הכנסות כלליות
- [x] `POST /api/commissions/admin/process-payout` - עיבוד תשלום חודשי

---

### **PHASE 2: Owner Dashboard Integration**

#### **Step 2.1: Owner Main Screen Updates** ✅
- [x] הוספת קארד "הכנסות החודש" במסך האינטרו
- [x] תצוגת סכום נטו צבור (החודש הנוכחי)
- [x] מועד תשלום קרוב + ספירה לאחור
- [x] אנימציה לעדכונים בזמן אמת
- [x] אייקונים ועיצוב מותאם
- [x] כפתור "פירוט" שמוביל לסקירה כללית

#### **Step 2.2: Detailed Commission Screen** ✅
- [x] שיפור מסך "סקירה כללית" להציג עמלות
- [x] ניווט בין חודשים לעמלות
- [x] תצוגת KPIs של עמלות (נטו, עמלה, הזמנות)
- [x] שילוב עם הזמנות קיימות
- [x] רענון נתונים
- [x] הסרת קארד עמלות ממסך "ניהול החניות"

#### **Step 2.3: Real-time Updates** ⏳
- [ ] WebSocket לעדכוני עמלות בזמן אמת
- [ ] הודעות על הזמנות חדשות + עמלה
- [ ] הודעות על תשלומים מתקרבים
- [ ] סנכרון עם רענון האפליקציה

---

### **PHASE 3: Admin Dashboard Features**

#### **Step 3.1: Commission Revenue Screen** ✅
- [x] מסך הכנסות מבעלי חניה
- [x] סינון לפי חודשים/שנים
- [x] תצוגת הכנסות זפוטו ובעלי חניות
- [x] פירוט לפי בעל חניה
- [x] סיכום חודשי מפורט

#### **Step 3.2: Parking Analytics Updates** ✅
- [x] עדכון מסך פרטי החניה
- [x] הצגת הכנסה נטו של בעל החניה
- [x] הצגת עמלות זפוטו מהחניה
- [x] פירוט עמלות לפי הזמנה
- [x] טעינת נתוני עמלות ספציפיים לחניה

#### **Step 3.3: Payout Management** ✅
- [x] מסך ניהול תשלומים חודשיים
- [x] בחירת חודש לעיבוד תשלומים
- [x] תצוגת סיכום עמלות לכל בעל חניה
- [x] כפתור עיבוד תשלום עם אישור
- [x] אינטגרציה עם API תשלומים

---

### **PHASE 4: Integration & Testing**

#### **Step 4.1: Booking Flow Integration** ✅
- [x] עדכון תהליך ההזמנה לכלול חישוב עמלה
- [x] אחסון נתוני עמלה בהזמנה (15% עמלה אוטומטית)
- [x] יצירת רשומת Commission עם כל פרט
- [x] טיפול בביטולים והחזרים (מחיקת עמלה)
- [x] לוגים מפורטים לכל חישוב

#### **Step 4.2: Payment Processing** ✅
- [x] אוטומציה לתשלומים חודשיים (processMonthlyPayouts)
- [x] Cron Job לעיבוד תשלומים ב-1 לחודש (scheduler.ts)
- [x] API endpoints לבדיקה ידנית (/api/jobs/monthly-payouts)
- [x] כפתור בדיקה ידנית במסך האדמין
- [x] בדיקת בריאות מערכת יומית

#### **Step 4.3: Comprehensive Testing** ✅
- [x] בדיקות אינטגרציה מלאות (CommissionIntegrationTests)
- [x] בדיקת תהליך מלא: הזמנה → עמלה → תשלום
- [x] בדיקת ביטול הזמנות ומחיקת עמלות
- [x] בדיקת עמלות מרובות לבעל חניה אחד
- [x] בדיקות תרחישי קיצון (מחיר 0, תשלומים ריקים)
- [x] API endpoints לבדיקות (/api/jobs/test-commission-system)
- [x] כפתור בדיקות במסך האדמין

---

### **PHASE 5: Documentation & Deployment**

#### **Step 5.1: Documentation** ⏳
- [ ] תיעוד API מלא
- [ ] מדריך למשתמשים (בעלי חניה)
- [ ] מדריך לאדמינים
- [ ] תיעוד הגדרות מערכת
- [ ] FAQ ופתרון בעיות נפוצות

#### **Step 5.2: Deployment & Monitoring** ⏳
- [ ] פריסה בסביבת בדיקות
- [ ] בדיקות קבלה עם בעלי חניה נבחרים
- [ ] פריסה בסביבת ייצור
- [ ] מוניטורינג וחיישנים
- [ ] גיבויים ותוכנית שחזור

---

## 🛠️ **טכנולוגיות ורכיבים**

### Backend:
- **Node.js/Express** - API Server
- **PostgreSQL** - Database
- **Cron Jobs** - תשלומים אוטומטיים
- **WebSocket** - עדכונים בזמן אמת

### Frontend:
- **React Native** - אפליקציה
- **React** - Admin Dashboard
- **Charts.js** - גרפים ותרשימים
- **PDF Generation** - דוחות

### External Services:
- **Payment Gateway** - תשלומים
- **SMS/Email** - הודעות
- **Analytics** - מעקב שימוש

---

## 📊 **KPIs ומדדי הצלחה**

### עסקיים:
- [ ] זמן תגובה לחישוב עמלה < 100ms
- [ ] דיוק חישובים 100%
- [ ] זמן עיבוד תשלום חודשי < 24 שעות
- [ ] שיעור שביעות רצון בעלי חניה > 90%

### טכניים:
- [ ] זמינות מערכת > 99.9%
- [ ] ביצועי מסד נתונים מתחת ל-50ms
- [ ] כיסוי בדיקות > 90%
- [ ] אבטחת נתונים פיננסיים

---

## 🔐 **שיקולי אבטחה**

- [ ] הצפנת נתונים פיננסיים
- [ ] אימות זהות חזק למסכי אדמין
- [ ] Audit Trail לכל פעולות עמלה
- [ ] הגנה מפני SQL Injection
- [ ] Rate Limiting על APIs רגישים

---

**📅 תאריך יצירה:** 25/10/2025  
**👨‍💻 מפתח:** Senior Developer  
**⏱️ זמן משוער:** 4-6 שבועות  
**🎯 סטטוס:** הכנה לביצוע ⏳
