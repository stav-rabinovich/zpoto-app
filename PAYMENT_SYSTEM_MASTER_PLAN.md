# תכנית מאסטר - תיקון מערכת התשלומים והקופונים בזפוטו

## 🎯 מטרת התכנית
תיקון מלא של מערכת התשלומים והקופונים כך שתעבוד בסנכרון מושלם בין בקאנד לפרונטאנד עם נתונים מדויקים לכל הממשקים.

## 📊 המודל הנכון (לפי הדוגמה שלך)

### מקרה בסיס - חניה ₪10/שעה × 2 שעות ללא קופון:
- **בעל חניה ברוטו:** ₪20 (₪10 × 2 שעות)
- **עמלה לזפוטו:** ₪3 (15% מ-₪20) 
- **בעל חניה נטו:** ₪17 (₪20 - ₪3)
- **דמי תפעול:** ₪2 (10% מ-₪20)
- **לקוח משלם:** ₪22 (₪20 + ₪2)
- **זפוטו סה"כ:** ₪5 (₪3 עמלה + ₪2 דמי תפעול)

### מקרה עם קופון TEST50 (50% הנחה על דמי תפעול):
- **בעל חניה ברוטו:** ₪20 (לא משתנה)
- **עמלה לזפוטו:** ₪3 (לא משתנה - 15% מ-₪20)
- **בעל חניה נטו:** ₪17 (לא משתנה)
- **דמי תפעול:** ₪1 (₪2 - 50% = ₪1)
- **לקוח משלם:** ₪21 (₪20 + ₪1)
- **זפוטו סה"כ:** ₪4 (₪3 עמלה + ₪1 דמי תפעול)

---

## 📋 תכנית פעולה - 6 שלבים עיקריים

### שלב 1: מיפוי וניתוח המצב הקיים
**מטרה:** הבנה מלאה של המערכת הנוכחית ובעיותיה

#### 1.1 בדיקת בקאנד - מבנה הנתונים
- [ ] 📊 בדיקת טבלת `booking` - מה נשמר בפועל
- [ ] 💰 בדיקת טבלת `commission` - איך מחושבות העמלות
- [ ] 💳 בדיקת טבלת `operationalFee` - איך מחושבים דמי התפעול
- [ ] 🎫 בדיקת טבלת `couponUsage` - איך נרשמים קופונים
- [ ] 🔍 בדיקת חיבור בין הטבלאות
- [ ] v

#### 1.2 בדיקת בקאנד - לוגיקה עסקית
- [ ] 📝 מיפוי `payments.routes.ts` - תהליך התשלום המלא
- [ ] 🏗️ מיפוי `bookings.service.ts` - יצירת הזמנות ועמלות
- [ ] 💳 מיפוי `operationalFees.service.ts` - חישוב דמי תפעול
- [ ] 🎫 מיפוי `coupon.service.ts` - לוגיקת קופונים
- [ ] 🔄 בדיקת סדר הביצוע והתלויות
- [ ] v

#### 1.3 בדיקת פרונטאנד - ממשקי משתמש
- [ ] 👤 בדיקת ממשק מחפש חניה - מה מוצג ומה לא
- [ ] 🏠 בדיקת ממשק בעל חניה - נתוני הכנסות ועמלות
- [ ] 👑 בדיקת ממשק אדמין - דף הכנסות וכרטיסיות
- [ ] 📱 בדיקת רכיב תשלום ושימוש בקופונים
- [ ] 🔍 זיהוי פערים בין נתונים המוצגים למציאות
- [ ] v

#### 1.4 יצירת דוח בעיות
- [ ] 📝 רשימת כל הבעיות שזוהו בבקאנד
- [ ] 📝 רשימת כל הבעיות שזוהו בפרונטאנד
- [ ] 🔗 זיהוי בעיות תקשורת בין בקאנד לפרונטאנד
- [ ] 🎯 קביעת סדרי עדיפויות לתיקון
- [ ] v

---

### שלב 2: תיקון הבקאנד - מבנה נתונים ולוגיקה עסקית
**מטרה:** וידוא שהבקאנד שומר ומחשב נתונים נכון

#### 2.1 תיקון טבלת העמלות (commissions)
- [x] ✅ וידוא שהעמלה תמיד 15% מהכנסה ברוטו של בעל החניה
- [x] ✅ וידוא שהעמלה לא משתנה עם קופונים
- [x] ✅ וידוא חישוב נטו נכון: ברוטו - עמלה
- [x] ✅ תיקון `createCommissionForBooking` אם נדרש
- [x] v

#### 2.2 תיקון טבלת דמי התפעול (operationalFees)
- [x] ✅ וידוא שדמי התפעול 10% מהכנסה ברוטו בסיסי
- [x] ✅ וידוא שקופונים מפחיתים רק דמי תפעול
- [x] ✅ תיקון `createOperationalFee` להתמודד עם קופונים
- [x] ✅ וידוא עדכון נכון אחרי שימוש בקופון
- [x] v

#### 2.3 תיקון לוגיקת קופונים
- [x] ✅ וידוא שקופונים חלים רק על דמי תפעול
- [x] ✅ תיקון חישוב הנחה (אחוז/סכום קבוע)
- [x] ✅ וידוא רישום נכון של שימוש בקופון
- [x] ✅ וידוא עדכון מונה שימושים
- [x] v

#### 2.4 תיקון תהליך התשלום המלא
- [x] ✅ תיקון `payments.routes.ts` - סדר פעולות נכון
- [x] ✅ וידוא יצירת הזמנה עם נתונים בסיסיים
- [x] ✅ וידוא יצירת עמלה לפי הכנסה ברוטו
- [x] ✅ וידוא יצירת דמי תפעול בסיסיים
- [x] ✅ וידוא עדכון אחרי קופון אם נדרש
- [x] ✅ וידוא תקינות איזון כספי כולל
- [x] v

#### 2.5 יצירת API endpoints לנתונים
- [x] 📊 API לנתוני הכנסות אדמין (עמלות + דמי תפעול)
- [x] 👤 API לנתוני מחפש חניה (פרטי הזמנה ותשלום)
- [x] 🏠 API לנתוני בעל חניה (הכנסות ועמלות)
- [x] 🧪 בדיקות API עם נתונים אמיתיים
- [x] v

---

### שלב 3: תיקון הפרונטאנד - ממשק מחפש חניה
**מטרה:** מחפש חניה רואה נתונים מדויקים

#### 3.1 רכיב התשלום והקופון
- [x] 💳 תיקון חישוב מחיר בזמן אמת
- [x] 🎫 תיקון הצגת הנחת קופון
- [x] 💰 תיקון הצגת סכום סופי לתשלום
- [x] ⚡ תיקון עדכון מיידי אחרי הזנת קופון
- [x] 🔍 הוספת פירוט שקוף של לאן הולך הכסף
- [x] v

#### 3.2 דף פרטי הזמנה
- [ ] 📋 תיקון הצגת פירוט עלויות מלא
- [ ] 🏠 הצגת עלות חניה בסיסית
- [ ] 💳 הצגת דמי תפעול (עם/בלי קופון)
- [ ] 🎫 הצגת פרטי קופון אם נוצל
- [ ] 💰 הצגת סכום סופי ששולם
- [ ] v

#### 3.3 היסטורית הזמנות
- [ ] 📋 תיקון הצגת רשימת הזמנות עם נתונים נכונים
- [ ] 💰 תיקון הצגת סכומים בהיסטוריה
- [ ] 🎫 הצגת קופונים שנוצלו
- [ ] v

---

### שלב 4: תיקון הפרונטאנד - ממשק בעל חניה
**מטרה:** בעל חניה רואה הכנסות ועמלות נכונות

#### 4.1 דף הכנסות - סיכום כללי
- [ ] 💰 תיקון הצגת סך הכנסות ברוטו
- [ ] 💸 תיקון הצגת סך עמלות לזפוטו
- [ ] 💵 תיקון הצגת סך הכנסות נטו
- [ ] 📊 תיקון גרפים וסטטיסטיקות
- [ ] v

#### 4.2 רשימת הזמנות מפורטת
- [ ] 📋 הצגת פרטי הזמנה עם חישובים נכונים
- [ ] 🏠 הצגת הכנסה ברוטו לכל הזמנה
- [ ] 💸 הצגת עמלה לזפוטו לכל הזמנה
- [ ] 💵 הצגת הכנסה נטו לכל הזמנה
- [ ] 📅 מיון וסינון נכונים
- [ ] v

#### 4.3 דוחות ואנליטיקה
- [ ] 📊 דוח הכנסות חודשי/שנתי
- [ ] 📈 מגמות והשוואות
- [ ] 💡 תובנות על ביצועים
- [ ] v

---

### שלב 5: תיקון הפרונטאנד - ממשק אדמין
**מטרה:** אדמין רואה נתוני הכנסות זפוטו מדויקים

#### 5.1 דף הכנסות - כרטיסיות מרכזיות
- [ ] 🏷️ כרטיסיה "עמלות מבעלי חניה (15%)"
- [ ] 🏷️ כרטיסיה "דמי תפעול ממחפשי חניה (10%)"
- [ ] 🏷️ כרטיסיה "סה״כ הכנסות זפוטו"
- [ ] 📊 חישובים נכונים בזמן אמת
- [ ] v

#### 5.2 פירוט הכנסות לפי תקופות
- [ ] 📅 סינון לפי תאריך
- [ ] 📊 פירוט יומי/שבועי/חודשי
- [ ] 📈 גרפים ומגמות
- [ ] 📋 ייצוא דוחות
- [ ] v

#### 5.3 ניהול קופונים
- [ ] 🎫 רשימת קופונים עם סטטיסטיקות שימוש
- [ ] 📊 השפעת קופונים על הכנסות
- [ ] 🔍 מעקב אחר קופונים פעילים
- [ ] v

#### 5.4 אנליטיקה מתקדמת
- [ ] 📊 השוואות לתקופות קודמות
- [ ] 🎯 תובנות עסקיות
- [ ] 📈 מדדי ביצועים
- [ ] v

---

### שלב 6: בדיקות מקיפות ואישור סופי
**מטרה:** וידוא שהמערכת עובדת מושלם

#### 6.1 בדיקות פונקציונליות
- [ ] 🧪 בדיקת תרחיש מלא ללא קופון
- [ ] 🧪 בדיקת תרחיש מלא עם קופון אחוזים
- [ ] 🧪 בדיקת תרחיש מלא עם קופון סכום קבוע
- [ ] 🧪 בדיקת מקרי קצה ושגיאות
- [ ] v

#### 6.2 בדיקות סנכרון
- [ ] 🔄 וידוא סנכרון בין בקאנד לפרונטאנד
- [ ] 📊 וידוא תואמות נתונים בכל הממשקים
- [ ] ⚡ וידוא עדכון בזמן אמת
- [ ] v

#### 6.3 בדיקות ביצועים
- [ ] ⚡ מהירות טעינת נתונים
- [ ] 📊 יעילות חישובים
- [ ] 🔄 יציבות בעומס
- [ ] v

#### 6.4 אישור משתמשים
- [ ] ✅ אישור מחפש חניה - נתונים נכונים ומובנים
- [ ] ✅ אישור בעל חניה - הכנסות ועמלות מדויקות
- [ ] ✅ אישור אדמין - נתוני הכנסות זפוטו נכונים
- [ ] v

---

## 🎯 קריטריונים להצלחה

### נתונים שיהיו תואמים בכל הממשקים:
1. **הכנסה ברוטו בעל חניה** = מחיר שעתי × שעות
2. **עמלה לזפוטו** = 15% מהכנסה ברוטו (לא משתנה בקופון)
3. **הכנסה נטו בעל חניה** = ברוטו - עמלה
4. **דמי תפעול** = 10% מהכנסה ברוטו (פחות קופון אם יש)
5. **תשלום לקוח** = הכנסה ברוטו + דמי תפעול
6. **הכנסות זפוטו** = עמלה + דמי תפעול

### איזון כספי:
**תשלום לקוח = הכנסה נטו בעל חניה + הכנסות זפוטו**

### בכל תרחיש (עם/בלי קופון):
- ✅ בעל החניה מקבל אותה הכנסה נטו
- ✅ זפוטו מקבלת אותה עמלה
- ✅ רק דמי התפעול משתנים (= לקוח משלם פחות)

---

## 📁 קבצים עיקריים לעדכון

### Backend:
- `src/routes/payments.routes.ts`
- `src/services/bookings.service.ts`
- `src/services/operationalFees.service.ts`
- `src/services/coupon.service.ts`
- `prisma/schema.prisma` (אם נדרש)

### Frontend:
- רכיבי תשלום וקופון
- ממשק מחפש חניה
- ממשק בעל חניה - דף הכנסות
- ממשק אדמין - דף הכנסות

---

**📅 זמן משוער:** 2-3 ימי עבודה מרוכזת
**🎯 מטרה:** מערכת תשלומים וקופונים עובדת בסנכרון מושלם

---

*תאריך יצירה: 1.11.2025*  
*מטרה: תיקון מלא מערכת התשלומים והקופונים בזפוטו*
