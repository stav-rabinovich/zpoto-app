# 📋 תכנית מערכת קופונים - כללי ברזל

## 🎯 כללים בסיסיים (אסור לגעת!)

### 💰 מבנה מחירים קיים
1. **מחיר עלות חניה** = מחיר לפי מחירון × שעות ✅ (עובד מעולה)
2. **מחיר שמשלם מחפש חניה** = עלות חניה + דמי תפעול (10%) ✅ (עובד מעולה)
3. **התשלום לבעל החניה** = תמיד המחיר שמשלם מחפש חניה ✅ (עובד מעולה)
4. **עמלות בעלי חניות (15%)** ✅ (עובד מעולה - אסור לגעת!)

### 🎫 כללי קופונים
- **קופונים פועלים רק על דמי התפעול** 
- **2 סוגי קופונים:** אחוז או סכום קבוע
- **מגבלה:** הנחה לא יכולה לעלות על דמי התפעול

## 📊 דוגמה מעשית

### מקרה בסיס
- מחיר חניה: ₪10 לשעה
- דמי תפעול: ₪1 (10%)
- **מחיר כולל: ₪11**

### עם קופון FREE5 (₪5 קבוע)
- הנחה: min(₪5, ₪1) = ₪1
- דמי תפעול אחרי הנחה: ₪0
- **מחיר סופי: ₪10**

### עם קופון TEST10 (10% אחוז)
- הנחה: 10% × ₪1 = ₪0.1
- דמי תפעול אחרי הנחה: ₪0.9
- **מחיר סופי: ₪10.9**

## 🔄 השפעות במערכת

### 👤 מחפש חניה
- רואה ומשלם: ₪10.9
- מקבל קבלה על: ₪10.9

### 🏢 ממשק אדמין
- הכנסה מדמי תפעול: ₪0.9 (לא ₪1!)
- סה"כ הכנסה ממחפש חניה: ₪10.9

### 🏠 בעל החניה
- **אסור לגעת!** מערכת עובדת מצוין ✅

---

# 🛠️ תכנית ביצוע

## Step 1: ✅ תיקון Backend API
**מטרה:** וידוא שהשרת מחשב הנחות נכון רק על דמי תפעול

### משימות:
- [x] וידוא שקיימים קופוני TEST10 ו-FREE5
- [x] בדיקת חישובי השרת
- [x] תמיכה בקופונים על סכום כולל וגם דמי תפעול

**Status: ✅ הושלם**

---

## Step 2: ✅ תיקון Frontend - חישובים
**מטרה:** החישובים בצד הלקוח מתאימים לכללי הברזל

### משימות:
- [x] זיהוי איך `paymentAmount` מחושב
- [x] תיקון `paymentAmount` לכלול דמי תפעול (10%)
- [x] תיקון חישוב הנחות בממשק (פירוק נכון)
- [x] וידוא שמחיר סופי = עלות חניה + דמי תפעול לאחר הנחה
- [x] בדיקת תוצאות עם קופוני TEST10 ו-FREE5

**Status: ✅ הושלם**

---

## Step 3: ✅ תיקון Frontend - תצוגה
**מטרה:** התצוגה במסך התשלום מדויקת

### משימות:
- [x] פירוט תשלום: עלות חניה + דמי תפעול נפרד
- [x] תצוגת הנחה: הבחנה נכונה בין אחוז לסכום קבוע
- [x] מחיר סופי: עלות חניה + דמי תפעול לאחר הנחה
- [x] כפתור תשלום: המחיר הסופי המתוקן
- [x] שורת חיסכון: חישוב מדויק לפי כללי הברזל

**Status: ✅ הושלם**

---

## Step 4: ✅ אינטגרציה תשלומים
**מטרה:** תהליך התשלום עובר עם המחיר הנכון

### משימות:
- [x] וידוא שהתשלום עובר עם המחיר הסופי (`finalAmount`)
- [x] הוספת פרטי קופון לבקשת התשלום
- [x] עדכון סטטוס קופון (מונה שימושים)
- [x] שמירת רשומת שימוש בקופון (`CouponUsage`)
- [x] עדכון Prisma Client לתמיכה במודלי קופון

**Status: ✅ הושלם**

---

## Step 5: ✅ ממשק אדמין - הכנסות
**מטרה:** הכנסות מדמי תפעול מותאמות להנחות

### משימות:
- [x] חישוב הכנסות מדמי תפעול לפני ואחרי הנחות
- [x] הוספת נתוני דמי תפעול ל-API סטטיסטיקות
- [x] הוספת כרטיס דמי תפעול לדשבורד
- [x] יצירת טאב קופונים עם סטטיסטיקות מפורטות
- [x] תצוגת אחוז חיסכון מקופונים

**Status: ✅ הושלם**

---

## Step 6: 🏠 התראות בעלי חניות
**מטרה:** בעל החניה מקבל את המידע הנכון

### משימות:
- [ ] וידוא שבעל החניה רואה רק מחיר החניה (בלי דמי תפעול)
- [ ] עמלות 15% מחושבות נכון מעלות החניה
- [ ] התראות על הזמנות חדשות

**Status: ⏳ ממתין**

---

## Step 7: 🧪 בדיקות מערכת
**מטרה:** כל התרחישים עובדים נכון

### בדיקות:
- [ ] קופון אחוז על דמי תפעול קטנים
- [ ] קופון סכום קבוע גדול מדמי התפעול
- [ ] קופון על סכום כולל
- [ ] תרחישים קיצוניים

**Status: ⏳ ממתין**

---

## Step 8: 📚 תיעוד וסיום
**מטרה:** תיעוד המערכת והשלמת הפרויקט

### משימות:
- [ ] תיעוד API
- [ ] מדריך למשתמש אדמין
- [ ] בדיקה סופית

**Status: ⏳ ממתין**

---

# 🎯 יעד סופי
בסיום התכנית, מערכת הקופונים תעבוד:
- ✅ **נכון** - חישובים מדויקים לפי כללי הברזל
- ✅ **נקי** - ממשק פשוט ומובן
- ✅ **מסונכרן** - כל הממשקים מתעדכנים אחד עם השני
